<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<title>My Å koda Reviews â€” AppFigures Embed</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --brand:#4BA82E; --ink:#0f172a; --muted:#6b7280; --bg:#f6f8fb; --card:#fff;
    --border:rgba(17,24,39,.10); --ring:rgba(75,168,46,.20);
    --dot-green:#10B981; --dot-yellow:#F59E0B; --dot-red:#EF4444; --star:#FFC107;
  }
  /* Dark theme overrides */
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --card-2:#0b1425;
    --ink:#e5e7eb; --muted:#9ca3af;
    --border:rgba(255,255,255,.12);
    --ring:rgba(75,168,46,.35);
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border);background:var(--card)}
  .hdr{max-width:1200px;margin:0 auto;padding:20px 16px;text-align:center;position:relative}
  .title{margin:0;font-size:28px} .title .brand{color:var(--brand)}
  .hdr-actions{position:absolute;right:16px;top:16px;display:flex;gap:8px}
  .iconbtn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:transparent;color:var(--ink);
    border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
  .iconbtn:hover{box-shadow:0 0 0 4px var(--ring);border-color:var(--brand)}
  .flagbtn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border:1px solid var(--border);
    background:transparent;border-radius:999px;cursor:pointer;font-size:18px}
  .flagbtn.selected{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}

  .container{max-width:1200px;margin:0 auto;padding:18px 16px 40px}
  .row{display:flex;gap:16px;flex-wrap:wrap} .col{flex:1;min-width:280px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 2px 8px rgba(2,6,23,.06)}
  h2{margin:6px 0 6px;font-size:20px}

  .group{margin:12px 0} .group-label{font-size:12px;color:var(--muted);margin:0 0 8px 6px}
  .pills{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);
        border-radius:999px;background:transparent;font-weight:700;font-size:14px;cursor:pointer;color:var(--muted);
        transition:box-shadow .12s,border-color .12s,transform .06s,background .12s,color .12s}
  .pill:active{transform:translateY(1px)}
  .pill.selected{background:var(--brand);color:#fff;border-color:transparent;box-shadow:0 0 0 4px var(--ring)}
  .pills.is-all-on .pill:not(.pill--all):not(.selected){opacity:.45}
  .star{color:var(--star)} .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
  .dot.green{background:var(--dot-green)} .dot.yellow{background:var(--dot-yellow)} .dot.red{background:var(--dot-red)}
  .reviews-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .filtered-badge{margin-left:8px;color:var(--muted);font-size:12px;border:1px solid var(--border);padding:2px 8px;border-radius:999px;background:transparent}
  .toolbar{flex:1 1 100%} .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .select{height:40px;border:1px solid var(--border);border-radius:12px;background:transparent;color:var(--ink);padding:0 12px;font-weight:700}
  .btn{appearance:none;border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;background:transparent;color:var(--ink')}
  .btn:hover{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
  .review{border:1px solid var(--border);border-radius:16px;background:var(--card);padding:12px;box-shadow:0 2px 8px rgba(2,6,23,.06);display:flex;flex-direction:column;gap:8px}
  .review__head{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .rating{display:inline-flex;gap:6px;align-items:center;font-size:12px;font-weight:800;background:transparent;border:1px solid var(--border);border-radius:10px;padding:4px 10px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:12px;color:var(--ink)}
  .topic{background:rgba(75,168,46,.1);border:1px solid rgba(75,168,46,.25);color:#b7f7c2;border-radius:999px;padding:4px 8px;font-size:12px}
  .topics{display:flex;gap:6px;flex-wrap:wrap} .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px;align-items:center}

  .barrow{display:grid;grid-template-columns:1fr 3fr auto;gap:10px;align-items:center;padding:4px 0}
  .bar{background:var(--card-2, #eef2f7);height:12px;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),#7bd359)}

/* === Compact filters layout in Reviews toolbar === */
.reviews-head .toolbar{display:flex;flex-wrap:wrap;gap:12px 16px;align-items:flex-end}
.reviews-head .toolbar .group{margin:8px 16px 0 0}
.reviews-head .toolbar .actions{margin-left:auto;margin-top:0}

/* === Compact filters: inline-wrapping groups (safe for event wiring) === */
.reviews-head .toolbar{display:block}
.reviews-head .toolbar .group{display:inline-flex;flex-direction:column;vertical-align:bottom;margin:8px 16px 0 0}
.reviews-head .toolbar .actions{display:inline-flex;vertical-align:bottom;margin:8px 0 0 auto;gap:12px;align-items:center;flex-wrap:nowrap}

/* === Per-card mini language controls === */
.review__footer{display:flex;justify-content:space-between;align-items:flex-end;margin-top:10px;gap:12px}
.lang-slot{display:flex;flex-direction:column;align-items:flex-end;min-width:120px;min-height:40px}
.lang-mini{display:inline-flex;gap:6px}
.lang-mini .mini{appearance:none;border:1px solid var(--border);background:transparent;color:var(--ink);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px;line-height:1}
.lang-mini .mini.selected{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring);font-weight:700}
.see-original{min-height:16px;line-height:16px;font-size:12px;margin-top:4px;visibility:hidden}
.see-original.show{visibility:visible}
.see-original button{appearance:none;background:transparent;border:0;color:var(--link);cursor:pointer;text-decoration:underline;padding:0}

/* === Keep select styled to theme; but ensure dropdown options have dark readable text === */
.select option{color:#0b1020}
</style>
</head>
<body>
<header>
  <div class="hdr">
    <h1 class="title"><span class="brand">My Å koda</span> Reviews Dashboard</h1>
    <div class="hdr-actions">
      <div class="flagbar" role="group" aria-label="Language">
        <!-- EN / CS / DE flag buttons -->
        <button class="flagbtn" data-lang="en" title="English">ðŸ‡¬ðŸ‡§</button>
        <button class="flagbtn" data-lang="cs" title="ÄŒeÅ¡tina">ðŸ‡¨ðŸ‡¿</button>
        <button class="flagbtn" data-lang="de" title="Deutsch">ðŸ‡©ðŸ‡ª</button>
      </div>
      <button id="btn-theme" class="iconbtn" title="Toggle theme">ðŸŒ™ <span id="btn-theme-label">Dark</span></button>
    </div>
  </div>
</header>

<main class="container">
  <section class="row" style="margin-top:12px;">
    <div class="col card"><h2 id="tByTopic">By Topic</h2><div id="chart-topic"></div></div>
    <div class="col card"><h2 id="tByVersion">By Version</h2><div id="chart-version"></div></div>
    <div class="col card"><h2 id="tByStars">By Stars</h2><div id="chart-stars"></div></div>
  </section>

  <section class="card" style="margin-top:16px;">
    <div class="reviews-head">
      <div style="display:flex;align-items:center;gap:8px">
        <h2 id="tReviews" style="margin:0">Reviews</h2>
        <span id="filteredTag" class="filtered-badge" hidden>(filtered)</span>
      </div>
      <div class="toolbar">
        <div class="group"><div class="group-label" id="tPlatform">Platform</div><div class="pills" data-group="platform"></div></div>
        <div class="group"><div class="group-label" id="tRating">Rating</div><div class="pills" data-group="rating"></div></div>
        <div class="group"><div class="group-label" id="tUsefulness">Usefulness</div><div class="pills" data-group="usefulness"></div></div>
        <div class="group"><div class="group-label" id="tTopic">Topic</div><div class="pills" data-group="topic"></div></div>
        <div class="group"><div class="group-label" id="tCountry">Country</div><div class="pills" data-group="country"></div></div>
        <div class="actions">
          <label class="group-label" for="sortSelect" style="align-self:center" id="tSort">Sort</label>
          <select id="sortSelect" class="select" aria-label="Sort reviews">
            <option value="DEFAULT" id="optDefault">Default</option>
            <option value="STARS_ASC" id="optStarsAsc">Stars â†‘</option>
            <option value="STARS_DESC" id="optStarsDesc">Stars â†“</option>
            <option value="USE_ASC" id="optUseAsc">Usefulness â†‘</option>
            <option value="USE_DESC" id="optUseDesc">Usefulness â†“</option>
          </select>
          <button id="btn-clear" class="btn">Clear filters</button>
        </div>
      </div>
    </div>
    <div id="cards" class="grid" style="margin-top:12px;"></div>
  </section>
</main>

<footer style="border-top:1px solid var(--border);background:var(--card)">
  <div style="max-width:1200px;margin:0 auto;padding:22px 16px;text-align:center">
    <div class="footer-title"><span style="color:var(--brand)">My Å koda</span> Reviews Dashboard</div>
  </div>
</footer>

<!-- Embedded dataset -->
<script id="reviews-data" type="application/json">[/* â€¦ your long JSON stays exactly as you pasted â€¦ */]</script>

<script>
/* ===== Theme toggle (default dark) ===== */
(function(){
  const KEY='skoda_theme_v1';
  function apply(t){
    document.documentElement.setAttribute('data-theme', t);
    const btn=document.getElementById('btn-theme');
    const label=document.getElementById('btn-theme-label');
    if(btn&&label){ label.textContent=(t==='dark'?'Dark':'Light'); btn.firstChild.textContent=(t==='dark'?'ðŸŒ™':'â˜€ï¸'); }
    try{ localStorage.setItem(KEY,t); }catch(e){}
  }
  let saved=null; try{ saved=localStorage.getItem(KEY);}catch(e){}
  apply(saved || 'dark');
  const btn=document.getElementById('btn-theme');
  if(btn){ btn.addEventListener('click', ()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; apply(cur==='dark'?'light':'dark'); });}
})();

/* ===== i18n (UI only, not review bodies) ===== */
const LANG_KEY='skoda_lang_v1';
const I18N = {
  en: {byTopic:'By Topic', byVersion:'By Version', byStars:'By Stars', reviews:'Reviews', filtered:'(filtered)',
    platform:'Platform', rating:'Rating', usefulness:'Usefulness', topic:'Topic', country:'Country', sort:'Sort',
    default:'Default', starsAsc:'Stars â†‘', starsDesc:'Stars â†“', useAsc:'Usefulness â†‘', useDesc:'Usefulness â†“',
    clear:'Clear filters', table:'Table', date:'Date', snippet:'Snippet', noMatch:'No reviews match your filters.',
    all:'All', useful:'Useful', average:'Average', weak:'Weak' },
  cs: {byTopic:'Podle tÃ©matu', byVersion:'Podle verze', byStars:'Podle hvÄ›zdiÄek', reviews:'Recenze', filtered:'(filtrovÃ¡no)',
    platform:'Platforma', rating:'HodnocenÃ­', usefulness:'UÅ¾iteÄnost', topic:'TÃ©ma', country:'ZemÄ›', sort:'SeÅ™adit',
    default:'VÃ½chozÃ­', starsAsc:'HvÄ›zdiÄky â†‘', starsDesc:'HvÄ›zdiÄky â†“', useAsc:'UÅ¾iteÄnost â†‘', useDesc:'UÅ¾iteÄnost â†“',
    clear:'VyÄistit filtry', table:'Tabulka', date:'Datum', snippet:'UkÃ¡zka', noMatch:'Å½Ã¡dnÃ© recenze neodpovÃ­dajÃ­ filtrÅ¯m.',
    all:'VÅ¡e', useful:'UÅ¾iteÄnÃ¡', average:'PrÅ¯mÄ›rnÃ¡', weak:'SlabÃ¡' },
  de: {byTopic:'Nach Thema', byVersion:'Nach Version', byStars:'Nach Sterne', reviews:'Bewertungen', filtered:'(gefiltert)',
    platform:'Plattform', rating:'Bewertung', usefulness:'NÃ¼tzlichkeit', topic:'Thema', country:'Land', sort:'Sortieren',
    default:'Standard', starsAsc:'Sterne â†‘', starsDesc:'Sterne â†“', useAsc:'NÃ¼tzlichkeit â†‘', useDesc:'NÃ¼tzlichkeit â†“',
    clear:'Filter lÃ¶schen', table:'Tabelle', date:'Datum', snippet:'Ausschnitt', noMatch:'Keine Bewertungen entsprechen den Filtern.',
    all:'Alle', useful:'NÃ¼tzlich', average:'Durchschnittlich', weak:'Schwach' }
};
let LANG = (function(){ try{return localStorage.getItem(LANG_KEY)||'en';}catch(e){return 'en';} })();
function t(k){ return (I18N[LANG] && I18N[LANG][k]) || I18N.en[k] || k; }
function applyLangStatic(){
  const set = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = txt; };
  set('tByTopic', t('byTopic')); set('tByVersion', t('byVersion')); set('tByStars', t('byStars'));
  set('tReviews', t('reviews')); set('tPlatform', t('platform')); set('tRating', t('rating'));
  set('tUsefulness', t('usefulness')); set('tTopic', t('topic')); set('tCountry', t('country'));
  set('tSort', t('sort')); set('optDefault', t('default')); set('optStarsAsc', t('starsAsc'));
  set('optStarsDesc', t('starsDesc')); set('optUseAsc', t('useAsc')); set('optUseDesc', t('useDesc'));
  set('btn-clear', t('clear')); set('tTable', t('table'));
  set('thDate', t('date')); set('thPlatform', t('platform')); set('thStars', t('rating'));
  set('thUsefulness', t('usefulness')); set('thTopic', t('topic')); set('thCountry', t('country')); set('thSnippet', t('snippet'));
  const tag=document.getElementById('filteredTag'); if(tag && !tag.hidden) tag.textContent = t('filtered');
  document.querySelectorAll('.flagbtn').forEach(b=> b.classList.toggle('selected', b.dataset.lang===LANG));
}
(function(){
  applyLangStatic();
  document.querySelectorAll('.flagbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      LANG = b.dataset.lang || 'en';
      try{ localStorage.setItem(LANG_KEY, LANG);}catch(e){}
      applyLangStatic();
      initChoosers();
      applyFilters();
    });
  });
})();

/* ===== Data helpers ===== */
let RAW = [];
try { RAW = JSON.parse(document.getElementById('reviews-data').textContent || "[]"); }
catch(e) { console.error("JSON parse failed:", e); RAW = []; }

const uniq = arr => [...new Set(arr)];
const escapeHTML = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const flattenTopics = r => Array.isArray(r.topics_list)? r.topics_list : (r.topics? String(r.topics).split(';').map(x=>x.trim()).filter(Boolean):[]);
const countryFlag = cc => { if(!cc) return 'ðŸ³ï¸'; cc=String(cc).toUpperCase(); const A=0x1F1E6; return String.fromCodePoint(cc.charCodeAt(0)-65+A)+String.fromCodePoint(cc.charCodeAt(1)-65+A); };
const USE_THRESH={ WEAK_MAX:39, AVERAGE_MIN:40, AVERAGE_MAX:59, USEFUL_MIN:60 };
const useCat = s => (Number(s)>=USE_THRESH.USEFUL_MIN?'USEFUL': (Number(s)>=USE_THRESH.AVERAGE_MIN && Number(s)<=USE_THRESH.AVERAGE_MAX?'AVERAGE':'WEAK'));
const useLabel = c => c==='USEFUL'?t('useful'):(c==='AVERAGE'?t('average'):t('weak'));
const useDot = c => c==='USEFUL'?'green':(c==='AVERAGE'?'yellow':'red');

const state = { platformAll:true, platform:new Set(), ratingAll:true, rating:new Set(),
  usefulnessAll:true, usefulness:new Set(), topicAll:true, topic:new Set(), countryAll:true, country:new Set(),
  sort:'DEFAULT' };

function buildChooser(group, values, render){
  const wrap = document.querySelector(`.pills[data-group="${group}"]`);
  if(!wrap) return;
  wrap.innerHTML='';
  const all = document.createElement('button');
  all.className='pill pill--all selected'; all.dataset.group=group; all.dataset.value='__ALL__'; all.textContent=t('all'); all.setAttribute('aria-pressed','true');
  wrap.appendChild(all);
  values.forEach(v=>{ const b=document.createElement('button'); b.className='pill'; b.dataset.group=group; b.dataset.value=String(v); b.setAttribute('aria-pressed','false'); b.innerHTML = render?render(v):String(v); wrap.appendChild(b); });
  wrap.classList.add('is-all-on');
}
function setAll(group){
  const wrap = document.querySelector(`.pills[data-group="${group}"]`);
  if(!wrap) return;
  wrap.querySelectorAll('.pill').forEach(p=>{ p.classList.remove('selected'); p.setAttribute('aria-pressed', p.classList.contains('pill--all')?'true':'false'); });
  wrap.querySelector('.pill--all').classList.add('selected'); wrap.classList.add('is-all-on');
  state[group].clear(); state[group+'All']=true; applyFilters();
}
function togglePill(btn){
  const group = btn.dataset.group, val = btn.dataset.value; const wrap = btn.closest('.pills');
  if(val==='__ALL__'){ setAll(group); return; }
  wrap.querySelector('.pill--all').classList.remove('selected'); wrap.querySelector('.pill--all').setAttribute('aria-pressed','false');
  wrap.classList.remove('is-all-on'); state[group+'All']=false;
  if(btn.classList.contains('selected')){ btn.classList.remove('selected'); btn.setAttribute('aria-pressed','false'); state[group].delete(val); }
  else { btn.classList.add('selected'); btn.setAttribute('aria-pressed','true'); state[group].add(val); }
  if(state[group].size===0){ setAll(group); return; } applyFilters();
}
function wireChoosers(){
  document.querySelectorAll('.pills').forEach(w=> w.addEventListener('click', e=>{ const pill=e.target.closest('.pill'); if(pill) togglePill(pill); }));
}
function initChoosers(){
  const platforms = uniq(RAW.map(r=>r.platform).filter(Boolean)).sort();
  buildChooser('platform', platforms, v=> v);
  buildChooser('rating', ['1','2','3','4','5'], v=> `<span class="star">â˜…</span> ${v}`);
  buildChooser('usefulness', ['USEFUL','AVERAGE','WEAK'], v=> `<span class="dot ${useDot(v)}"></span> ${useLabel(v)}`);
  const topics = uniq(RAW.flatMap(flattenTopics)).filter(Boolean).sort((a,b)=> a.localeCompare(b));
  buildChooser('topic', topics, v=> v);
  const ccodes = uniq(RAW.map(r=> String(r.country||'').toUpperCase()).filter(Boolean)).sort();
  buildChooser('country', ccodes, v=> `${countryFlag(v)} ${v}`);
  ['platform','rating','usefulness','topic','country'].forEach(g=>{ state[g].clear(); state[g+'All']=true; });
  wireChoosers();
}
function sortComparator(key){
  switch(key){
    case 'STARS_ASC': return (a,b)=> (a.rating||0)-(b.rating||0);
    case 'STARS_DESC': return (a,b)=> (b.rating||0)-(a.rating||0);
    case 'USE_ASC': return (a,b)=> (a.usefulness_score||0)-(b.usefulness_score||0);
    case 'USE_DESC': return (a,b)=> (b.usefulness_score||0)-(a.usefulness_score||0);
    default: return (a,b)=> String(b.date||'').localeCompare(String(a.date||''));
  }
}
document.getElementById('sortSelect').addEventListener('change', e=>{ state.sort = e.target.value || 'DEFAULT'; applyFilters(); });
function filtersActive(){ return !(state.platformAll && state.ratingAll && state.usefulnessAll && state.topicAll && state.countryAll); }
function updateFilteredTag(){ const tag=document.getElementById('filteredTag'); if(tag) tag.hidden = !filtersActive(); if(tag && !tag.hidden) tag.textContent = t('filtered'); }
function ratingBadge(n){ return `<span class="rating" role="img" aria-label="Rating: ${n} out of 5"><span class="star">â˜…</span><span>${n||'â€“'}</span></span>`; }

function card(r){
  const cc = String(r.country||'').toUpperCase(); const flag = countryFlag(cc);
  const cat = useCat(r.usefulness_score); const label = useLabel(cat); const dot = useDot(cat);
  const text = escapeHTML(r.review_text||'');
  const topics = (flattenTopics(r)||[]).map(t=>`<span class="topic">${escapeHTML(t)}</span>`).join('');
  const rawLang = String(r.language||'').toLowerCase();
const lang = (rawLang === 'cz') ? 'cs' : rawLang;
const isEN = lang==='en', isCS = lang==='cs', isDE = lang==='de';

  const id = escapeHTML(r.review_id||'');
  return `<article class="review" data-id="${id}" data-src-lang="${lang||''}">
    <div class="review__head">
      <div style="display:flex;gap:8px;align-items:center">
        ${ratingBadge(r.rating)} <span class="chip">${r.platform||'â€”'}</span>
      </div>
      <span class="chip"><span class="dot ${dot}"></span> ${label} Â· ${r.usefulness_score ?? 'â€”'}</span>
    </div>
    <div class="review-text">${text}</div>
    <div class="topics">${topics}</div>
    <div class="review__footer">
      <div class="meta">ðŸ“… ${String(r.date||'').replace('T',' Â· ')} â€¢ ${flag} ${cc} â€¢ App v${r.app_version||'n/a'}</div>
      <div class="lang-slot">
        <div class="lang-mini" role="group" aria-label="Translate to">
          <button class="mini${isEN?' selected':''}" data-to="en">EN</button>
          <button class="mini${isCS?' selected':''}" data-to="cs">CZ</button>
          <button class="mini${isDE?' selected':''}" data-to="de">DE</button>
        </div>
        <div class="see-original"><button type="button" class="see-original-btn">See original</button></div>
      </div>
    </div>
  </article>`;
}

function renderCards(rows){
  const el = document.getElementById('cards'); if(!el) return;
  el.innerHTML = rows.length? rows.map(card).join('') : `<div class="chip">${t('noMatch')}</div>`;
}
function bars(id, pairs){
  const root = document.getElementById(id); if(!root) return; root.innerHTML=''; const max=Math.max(...pairs.map(p=>p[1]||0),1);
  pairs.forEach(([label,val])=>{ const row=document.createElement('div'); row.className='barrow'; const lab=document.createElement('div'); lab.textContent=label;
    const bar=document.createElement('div'); bar.className='bar'; const fill=document.createElement('span'); fill.style.width=(100*val/max).toFixed(1)+'%'; bar.appendChild(fill);
    const v=document.createElement('div'); v.textContent=val; row.append(lab,bar,v); root.appendChild(row); });
}
function renderCharts(rows){
  const t={}; rows.forEach(r=> (flattenTopics(r)||[]).forEach(x=> t[x]=(t[x]||0)+1));
  bars('chart-topic', Object.entries(t).sort((a,b)=>b[1]-a[1]).slice(0,10));
  const v={}; rows.forEach(r=> v[r.app_version||'n/a']=(v[r.app_version||'n/a']||0)+1);
  bars('chart-version', Object.entries(v).sort((a,b)=>b[1]-a[1]).slice(0,10));
  const s={1:0,2:0,3:0,4:0,5:0}; rows.forEach(r=> s[r.rating]=(s[r.rating]||0)+1);
  bars('chart-stars', Object.entries(s));
}
function renderTable(rows){
  const tb=document.querySelector('#table tbody'); const empty=document.getElementById('tableEmpty'); if(!tb) return;
  if(!rows.length){ tb.innerHTML=''; if(empty) empty.style.display='block'; empty.textContent=t('noMatch'); return; } if(empty) empty.style.display='none';
  tb.innerHTML = rows.map(r=>{
    const cc=String(r.country||'').toUpperCase(); const snip=escapeHTML(String(r.review_text||'').slice(0,120)) + (String(r.review_text||'').length>120?'â€¦':'');
    return `<tr>
      <td>${String(r.date||'').split('T')[0]}</td>
      <td>${r.platform||''}</td>
      <td>â˜… ${r.rating||''}</td>
      <td>${useLabel(useCat(r.usefulness_score))} (${r.usefulness_score ?? 'â€”'})</td>
      <td>${escapeHTML((flattenTopics(r)||[]).join(', '))}</td>
      <td>${countryFlag(cc)} ${cc}</td>
      <td>${snip}</td>
    </tr>`;
  }).join('');
}
function applyFilters(){
  let rows = RAW.filter(r=>{
    if(!state.platformAll && !state.platform.has(r.platform)) return false;
    if(!state.ratingAll && !state.rating.has(String(r.rating))) return false;
    const cat = useCat(r.usefulness_score);
    if(!state.usefulnessAll && !state.usefulness.has(cat)) return false;
    if(!state.topicAll){ const t = (flattenTopics(r)||[]); if(!t.some(x=>state.topic.has(x))) return false; }
    if(!state.countryAll && !state.country.has(String(r.country||'').toUpperCase())) return false;
    return true;
  });
  rows = rows.slice().sort(sortComparator(state.sort));
  renderCards(rows); renderCharts(rows); renderTable(rows); updateFilteredTag();
}
document.getElementById('sortSelect').addEventListener('change', e=>{ state.sort = e.target.value || 'DEFAULT'; applyFilters(); });
document.getElementById('btn-clear').addEventListener('click', ()=>{ ['platform','rating','usefulness','topic','country'].forEach(g=> setAll(g)); applyFilters(); });

function boot(){ initChoosers(); applyFilters(); applyLangStatic(); }
boot();

/* === Translation: API helper (DeepL/OpenAI via Netlify function) === */
async function translateViaAPI(text, from, to, cacheKey){
  try{
    if(!to || !text || from===to) return text;
    // cache
    const hit = localStorage.getItem(cacheKey);
    if(hit) return hit;

    const res = await fetch('/.netlify/functions/translate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text, source: from, target: to })
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const out = (data && (data.text || data.translation || data.translatedText)) || text;
    localStorage.setItem(cacheKey, out);
    return out;
  }catch(err){
    console.warn('translateViaAPI failed, falling back:', err);
    return null; // signal to fallback
  }
}

/* === Fallback placeholder translator (only if API fails) === */
function translatePlaceholder(text, from, to){
  if(!text || !to || from===to) return text;
  const tag = `[${(from||'??').toUpperCase()}â†’${to.toUpperCase()}] `;
  const dict = {
    en:{ 'navigace':'navigation','kufr':'trunk','auto':'car' },
    cs:{ 'car':'auto','navigation':'navigace','trunk':'kufr','highway':'dÃ¡lnice' },
    de:{ 'car':'Auto','navigation':'Navigation','trunk':'Kofferraum','highway':'Autobahn' }
  };
  const map = dict[to] || {};
  // proper word boundaries and use the captured word
  return tag + String(text).replace(/\b([A-Za-zÃ-Å¾]+)\b/g, (m, word) =>
    map[word] || map[word.toLowerCase()] || word
  );
}


/* --- Per-card translate buttons (EN/CZ/DE) with API + fallback --- */
(function(){
  const root = document.getElementById('cards');
  if(!root) return;
  const ORIG = (window.__CARD_ORIG ||= new Map());

  root.addEventListener('click', async function(ev){
    const btn = ev.target.closest('.mini');
    const seeBtn = ev.target.closest('.see-original-btn');
    const card = ev.target.closest('article.review');
    if(!card) return;

    const id = card.getAttribute('data-id')||'';
    const srcLang = (card.getAttribute('data-src-lang')||'').toLowerCase();
    const textEl = card.querySelector('.review-text');
    const seeWrap = card.querySelector('.see-original');
    const buttons = card.querySelectorAll('.mini');

    if(btn){
      const to = (btn.dataset.to||'').toLowerCase();
      buttons.forEach(b=> b.classList.toggle('selected', b===btn));
      if(!ORIG.has(id)) ORIG.set(id, textEl.textContent||'');

      if(to && to===srcLang){
        // back to original language
        textEl.textContent = ORIG.get(id);
        seeWrap.classList.remove('show');
        return;
      }

      const orig = ORIG.get(id) || textEl.textContent || '';
      const cacheKey = id+':'+to;

      // 1) Try API
      const apiText = await translateViaAPI(orig, srcLang, to, cacheKey);
      if(apiText){
        textEl.textContent = `[${(srcLang||'??').toUpperCase()}â†’${to.toUpperCase()}] ` + apiText;
        seeWrap.classList.add('show');
        return;
      }

      // 2) Fallback placeholder so UI still changes even if API is down
      textEl.textContent = translatePlaceholder(orig, srcLang, to);
      seeWrap.classList.add('show');
      return;
    }

    if(seeBtn){
      if(ORIG.has(id)) textEl.textContent = ORIG.get(id);
      buttons.forEach(b=> b.classList.toggle('selected', (b.dataset.to||'')===srcLang));
      seeWrap.classList.remove('show');
      return;
    }
  });
})();
</script>
</body>
</html>
